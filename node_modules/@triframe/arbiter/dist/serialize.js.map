{"version":3,"sources":["../src/serialize.js"],"names":["primativeTypes","skippedPrototypes","Object","prototype","Function","Resource","EventEmitter","undefined","skippedProperties","target","serialize","$interface","config","io","main","isObject","Error","schema","serializeObject","defineProperty","enumerable","value","args","emit","name","object","descriptors","includes","__proto__","getOwnPropertyDescriptors","key","descriptor","type","attributes","metadata","isClass","serializeClass","isFunction","serializeFunction","isProperty","serializeProperty","isAttribute","serializeAttribute","Class","instance","className","classMethods","serializeMethods","instanceMethods","parent","isShared","readAccessTest","usesSession","isStream","original","toString","on","uid","patches","socket","send","onClose","cache","session","resource","getCached","constructor","updateSuccessful","invalidPatches","error","message","call","result","methodSession","accessSession","createSlice","sendSerialized","keepOpen","checkIntegrity","callback","serialized","serializeDocument","unshift","run","destroy","apply","err","callstack","captureStackTrace","catch","stack","isPipe","onChange","forceReload","observe","removeListeners","isPromise","then","validators","get","set","map","validator","isPrimative","isDateTime","isLuxonDateTime","isDocument","isArray","Array","every","isType","document","next","_class_","Promise","all","element","index","propertyName","propertyValue","namespace","console","warn","_proto_"],"mappings":"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","sourcesContent":["import { each, map, mapAsync, filter, EventEmitter, getMetadata, Resource } from '@triframe/core'\r\nimport { createCache, mergeBatch, mergePatches, stageNewPatches, createBatch, archivePatchesFor, updateResource } from './core'\r\n\r\n\r\nconst primativeTypes = ['String', 'Boolean', 'Number', 'Date', 'Function']\r\nconst skippedPrototypes = [Object.prototype, Function.prototype, Resource.prototype, Resource, EventEmitter.prototype, undefined, null]\r\nconst skippedProperties = target => (\r\n    typeof target === 'function'\r\n        ? ['length', 'name', 'prototype']\r\n        : ['constructor', '[[attributes]]', '[[patches]]', '[[base]]', '[[batch]]', '[[validationState]]']\r\n)\r\n\r\nexport const serialize = function ($interface, config= {}) {\r\n\r\n    const io = new EventEmitter\r\n\r\n    const main = () => {\r\n        if (!isObject($interface)) throw Error('$interface must be a plain JavaScript Object')\r\n        let schema = serializeObject('global', $interface)\r\n        Object.defineProperty(schema, 'emit', {\r\n            enumerable: false,\r\n            value: (...args) => io.emit(...args)\r\n        })\r\n        return schema\r\n    }\r\n\r\n    const serializeObject = function (name, object) {\r\n        let descriptors = {}\r\n        let $interface = {}\r\n        for (let target = object; !skippedPrototypes.includes(target); target = target.__proto__) {\r\n            each(Object.getOwnPropertyDescriptors(target), (key, descriptor) => {\r\n                if (!skippedProperties(target).includes(key)) {\r\n                    $interface[key] = object[key]\r\n                    descriptors[key] = descriptor\r\n                }\r\n            })\r\n        }\r\n        return {\r\n            type: 'object',\r\n            attributes: map($interface, (key, value) => {\r\n                const descriptor = descriptors[key]\r\n                const metadata = getMetadata(object, key)\r\n                if (isClass(value, descriptor)) return serializeClass(`${name}/${key}`, value, descriptor, metadata, object, key)\r\n                if (isObject(value, descriptor)) return serializeObject(`${name}/${key}`, value, descriptor, metadata, object, key)\r\n                if (isFunction(value, descriptor)) return serializeFunction(`${name}/${key}`, value, descriptor, metadata, object, key)\r\n                if (isProperty(value, descriptor)) return serializeProperty(`${name}/${key}`, value, descriptor, metadata, object, key)\r\n                if (isAttribute(value, descriptor)) return serializeAttribute(`${name}/${key}`, value, descriptor, metadata, object, key)\r\n            }),\r\n        }\r\n    }\r\n\r\n    const serializeClass = function (name, Class) {\r\n        const instance = new Class\r\n        return {\r\n            name,\r\n            type: 'class',\r\n            className: Class.name,\r\n            classMethods: serializeMethods(name, Class),\r\n            instanceMethods: serializeMethods(`${name}/#`, instance)\r\n        }\r\n    }\r\n\r\n\r\n    const serializeMethods = function (name, object) {\r\n        let descriptors = {}\r\n        for (let target = object; !skippedPrototypes.includes(target); target = target.__proto__) {\r\n            each(Object.getOwnPropertyDescriptors(target), (key, descriptor) => {\r\n                if (!skippedProperties(target).includes(key)) {\r\n                    descriptors[key] = descriptor\r\n                }\r\n            })\r\n        }\r\n        return map(descriptors, (key, descriptor) => {\r\n            const metadata = getMetadata(object, key)\r\n            if (isObject(descriptor.value, descriptor)) return serializeObject(`${name}/${key}`, descriptor.value, descriptor, metadata, object, key)\r\n            if (isFunction(descriptor.value, descriptor)) return serializeFunction(`${name}/${key}`, descriptor.value, descriptor, metadata, object, key)\r\n            if (isProperty(descriptor.value, descriptor)) return serializeProperty(`${name}/${key}`, descriptor.value, descriptor, metadata, object, key)\r\n            if (isAttribute(descriptor.value, descriptor)) return serializeAttribute(`${name}/${key}`, descriptor.value, descriptor, metadata, object, key)\r\n        })\r\n    }\r\n\r\n\r\n    const serializeFunction = function (name, value, descriptor, metadata, parent) {\r\n        const { isShared, readAccessTest, usesSession, isStream, original } = metadata;\r\n        if (isShared) {\r\n            return {\r\n                isStream,\r\n                name,\r\n                type: 'shared-function',\r\n                value: isStream ? original.toString() : value.toString()\r\n            }\r\n        } else {\r\n            io.on(name, async ({ args, uid, attributes, patches, socket, send, onClose }) => {\r\n                \r\n                socket.cache = socket.cache || createCache(socket)\r\n\r\n                const { session } = socket\r\n                \r\n                let resource;\r\n                if(uid) resource = await socket.cache.getCached(uid)\r\n                else resource = typeof parent === 'function' ? parent : new parent.constructor(attributes)\r\n\r\n                let { updateSuccessful, invalidPatches } = await updateResource(resource, patches, session)\r\n\r\n                if(!updateSuccessful){\r\n                    return send({ error: true, invalidPatches, message: 'You are not authorized to update the resource as requested' })\r\n                }\r\n\r\n                if ( readAccessTest !== undefined &&  !await readAccessTest.call(resource, { session, resource })) {\r\n                    return send({ error: true, message: 'You are not authorized to call this method' })\r\n                }\r\n                \r\n                let result, methodSession, accessSession = socket.session.createSlice();\r\n\r\n                const sendSerialized = async (value, keepOpen) => {\r\n                    //console.trace(name, value)\r\n                    if (usesSession) {methodSession.checkIntegrity() }\r\n                    const cache = socket.cache\r\n                    const session = accessSession\r\n                    const callback = () => sendSerialized(value, keepOpen)\r\n                    let serialized = await serializeDocument(value, { cache, session, callback })\r\n                    send(serialized, keepOpen)\r\n                }\r\n\r\n                if (usesSession) {\r\n                    methodSession = socket.session.createSlice()\r\n                    args.unshift(methodSession)\r\n                }\r\n\r\n                let run = () => {\r\n                    if(result && result.destroy) result.destroy()\r\n                    try {\r\n                        result = value.apply(resource, args)\r\n                    } catch (err) {\r\n                        send({ error: true, message: err.message, callstack: Error.captureStackTrace(err) })\r\n                    }\r\n                    if (result && result.catch) result.catch(err => {\r\n                        // Error.captureStackTrace(err)\r\n                        send({ error: true, message: err.message, callstack: err.stack })\r\n                    })\r\n                    if (isPipe(result)) {\r\n                        if(usesSession) methodSession.onChange(() => {\r\n                            result.forceReload()\r\n                        })\r\n                        result.observe(value => sendSerialized(value, true))\r\n                        socket.onClose(() => {\r\n                            result.destroy()\r\n                            if(methodSession) methodSession.removeListeners()\r\n                            if(accessSession) accessSession.removeListeners()\r\n                        })\r\n                    } else if (isPromise(result)) {\r\n                        result.then(value => sendSerialized(value))\r\n                    } else {\r\n                        sendSerialized(result)\r\n                    }\r\n                }\r\n                run()\r\n            })\r\n\r\n            return {\r\n                name,\r\n                type: 'remote-function'\r\n            }\r\n        }\r\n    }\r\n\r\n    const serializeProperty = function (name, value, descriptor, metadata, object, key) {\r\n        const { validators } = metadata\r\n        return {\r\n            name,\r\n            key: key,\r\n            type: 'property',\r\n            enumerable: descriptor.enumerable,\r\n            get: serializeFunction(`${name}.get`, descriptor.get || (() => null), descriptor, metadata, object),\r\n            set: serializeFunction(`${name}.set`, descriptor.set || (() => null), descriptor, metadata, object),\r\n            validators: validators && validators.map(validator => validator.toString())\r\n\r\n        }\r\n    }\r\n\r\n    const serializeAttribute = function (name, value, descriptor, metadata, object, key) {\r\n        const { validators } = metadata\r\n        return {\r\n            name,\r\n            key: key,\r\n            type: 'attribute',\r\n            value: descriptor.value,\r\n            validators: validators && validators.map(validator => validator.toString())\r\n        }\r\n    }\r\n\r\n    return main()\r\n}\r\n\r\nconst isPrimative = value => primativeTypes.includes(value.constructor.name)\r\nconst isDateTime = value => value.isLuxonDateTime === true\r\nconst isClass = (value) => typeof value === 'function' && isDocument(value.prototype)\r\nconst isDocument = value => value instanceof Resource\r\nconst isArray = value => Array.isArray(value)\r\nconst isObject = (value) => value && value.__proto__ === Object.prototype\r\nconst isFunction = (value) => typeof value === 'function' && !isClass(value)\r\nconst isProperty = (value, descriptor) => typeof descriptor.get === 'function' || typeof descriptor.set === 'function'\r\nconst isAttribute = (value, descriptor) => [isClass, isObject, isFunction, isProperty].every(isType => !isType(value, descriptor))\r\nconst isPipe = value => value && typeof value.observe == 'function'\r\nconst isPromise = value => value && typeof value.then == 'function' && !isPipe(value)\r\n\r\nconst serializeDocument = async function (document, { cache, session, callback }) {\r\n    const next = document => serializeDocument(document, { cache, session, callback })\r\n    if (!document) return document\r\n    if(isDateTime(document)) return document\r\n    if (isClass(document)) return { _class_: document.name }\r\n    if (isPrimative(document)) return document\r\n    if (isArray(document)) return await Promise.all(document.map((element, index) => next(element)))\r\n    if (isObject(document)) return await mapAsync(document, (propertyName, object) => next(object))\r\n    cache.cache(document) \r\n    if (isDocument(document)) return {\r\n        ... await mapAsync(document['[[attributes]]'], async (propertyName, propertyValue) => {\r\n            const metadata = getMetadata(document, propertyName)\r\n            const { readAccessTest, namespace } = metadata;\r\n            if(readAccessTest === undefined){\r\n                return await next(propertyValue)\r\n            } else {\r\n                //session.onChange( callback )\r\n                const resource = document\r\n                const result = readAccessTest.call(resource, { session, resource })\r\n                if(result instanceof Promise ) console.warn(`Running Asynchronous Authentication Checks for ${namespace} during serailization`)\r\n                if(!await result) return null\r\n                else return await next(propertyValue)\r\n            } \r\n        }),\r\n        _proto_: document.constructor.name\r\n    }\r\n\r\n}"],"file":"serialize.js"}