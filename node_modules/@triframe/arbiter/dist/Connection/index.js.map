{"version":3,"sources":["../../src/Connection/index.js"],"names":["id","connections","store","connection","unstore","Connection","ConnectionBase","constructor","ws","bind","emit","clientSecret","addEventListener","cancelationTimeout","setTimeout","closeListeners","forEach","l","session","sessionHead","createSlice","onClose","listener","push","listen","server","sessionModel","callback","Session","wss","Server","on","establishClientSecret","establishConnection","headers","request","cookie","parse","createSecret","serialize","data","target","strategy","identifier","split","removeEventListener","loadFor","send","result","characters","charactersLength","length","i","charAt","Math","floor","random"],"mappings":"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","sourcesContent":["import { Server } from './ws'\r\nimport cookie from 'cookie'\r\nimport { ConnectionBase } from './Base'\r\nimport { createSession } from './createSession'\r\n\r\nlet id = 0\r\nconst connections = {}\r\nconst store = (connection) => {\r\n    connections[++id] = connection\r\n    return id\r\n}\r\nconst unstore = (id) => {\r\n    delete connections[id]\r\n}\r\n\r\n\r\nexport class Connection extends ConnectionBase {\r\n    \r\n    constructor(ws){\r\n        super()\r\n        let id = store(this)\r\n        this.id = id\r\n        this.bind(ws)        \r\n        this.emit('__id__', id)\r\n        this.clientSecret = ws.clientSecret\r\n        ws.addEventListener('close', () => {\r\n            //unstore(id)\r\n            this.cancelationTimeout = setTimeout(() => {\r\n                this.closeListeners.forEach( l => l())\r\n            })\r\n        })\r\n    }\r\n\r\n    get session(){\r\n        return this.sessionHead ? this.sessionHead.createSlice() : null\r\n    }\r\n\r\n    closeListeners = []\r\n\r\n    onClose(listener){\r\n        this.closeListeners.push(listener)\r\n    }\r\n    \r\n    static listen(server, sessionModel, callback){\r\n\r\n        const Session = createSession(sessionModel)\r\n\r\n        const wss = new Server({ server });\r\n\r\n        wss.on('headers', establishClientSecret)\r\n       \r\n        wss.on('connection', ws => {\r\n            ws.addEventListener('message', establishConnection)\r\n        })\r\n\r\n        function establishClientSecret(headers, request, ws){\r\n            let { clientSecret } = cookie.parse(request.headers.cookie || '')\r\n            if(!clientSecret){\r\n                clientSecret = createSecret()\r\n                headers.push( `Set-Cookie: ${cookie.serialize('clientSecret', clientSecret)}`)\r\n            }\r\n            ws.clientSecret = clientSecret\r\n        }\r\n\r\n        async function establishConnection({ data, target }){\r\n            const [ strategy, identifier ] = data.split(' ')\r\n            switch(strategy){\r\n                case 'initialize':\r\n                    target.removeEventListener('message', establishConnection)\r\n                    let connection = new Connection(target)\r\n                    connection.sessionHead = await Session.loadFor(connection)\r\n                    callback(connection)\r\n                break;\r\n                case 'mount':\r\n                    target.removeEventListener('message', establishConnection)\r\n                    if(connections[identifier])\r\n                        connections[identifier].bind(target)\r\n                    else\r\n                        target.send('[\"__reload__\"]')\r\n                break;\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction createSecret(){\r\n    var result = '';\r\n    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    var charactersLength = characters.length;\r\n    for (var i = 0; i < 40; i++) {\r\n        result += characters.charAt(Math.floor(Math.random() * charactersLength));\r\n    }\r\n    return result;\r\n}"],"file":"index.js"}