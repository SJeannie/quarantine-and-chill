import { Connection } from './Connection'
import { createUnserializer } from './unserializer'

export const connect = (url = "/", { storage = null } = {}) => {
    if (url === "/") {
        if (typeof window !== 'undefined') {
            url = window.location.href;
        } else {
            throw Error('No valid URL provided to connect in Non-Browser Environment')
        }
    }
    return new Promise(resolve => {
        const io = Connection.establish(url)
        if (storage !== null) io.mountStorage(storage)
        const unserialize = createUnserializer(io)
        io.on('install', (apiSchema) => {
            const api = unserialize(apiSchema)
            resolve({ ...api, url })
        })
    })
}