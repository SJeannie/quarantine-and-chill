import fs from 'fs'
import mime from 'mime';
import ncp from 'ncp'

const UPLOADS_PATH = `./.storage`

export const cdnHandler = function(req, res){
    const path = req.url.replace('/cdn', `${UPLOADS_PATH}/`)
    const extension = path.split('.').pop()
    const stat = fs.statSync(path);
    const mimeType = mime.getType(extension);
    res.writeHead(200, {
        'Content-Type': mimeType,
        'Content-Length': stat.size
    });
    const readStream = fs.createReadStream(path);
    readStream.pipe(res);
}

export const cdnUploadHandler = function(req, res){
    const urls = []
    req.files.forEach(file => {
        const extension = file.name.split('.').pop()
        const filepath = `${createToken()}.${extension}`
        urls.push(`/cdn/${filepath}`)
        if (!fs.existsSync(UPLOADS_PATH)) {
            fs.mkdirSync(UPLOADS_PATH);
        }
        ncp(file.path, `${UPLOADS_PATH}/${filepath}`);
    })
    res.end(JSON.stringify(urls));
}

const createToken = () => {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < 12; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}